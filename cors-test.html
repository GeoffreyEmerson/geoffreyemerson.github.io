<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORS Test</title>
</head>
<body>
  <div style="display: grid; grid-template-columns: 1fr 1fr; column-gap: 20px;">
    <div>
      <h1>CORS Test Tool</h1>
      <form id="cors-form">
        <h3>URL</h3> 
        <input type="text" name="url" id="corsUrl" value="https://catfact.ninja/fact" size="100" />

        <h3>Method</h3>
        <input type="radio" name="method" value="GET" checked> GET
        <input type="radio" name="method" value="POST"> POST
        <input type="radio" name="method" value="OPTIONS"> OPTIONS

        <h3>Headers</h3>
        <table>
          <tr><td>Content-Type:</td><td><input type="text" name="content-type" id="contentType" value="application/json" size="81" /></td></tr>
          <tr><td>Accept-Encoding:</td><td><input type="text" name="Accept-Encoding" id="acceptEncoding" value="gzip, deflate, br" size="81" /></td></tr>
          <tr><td>Origin:</td><td><input type="text" name="Origin" id="origin" value="" size="81" /></td></tr>
          <tr><td>Access-Control-Allow-Origin:</td><td><input type="text" name="Access-Control-Allow-Origin" id="allow" value="" size="81" /></td></tr>
          <tr><td>Cookie:</td><td><input type="text" name="Cookie" id="cookie" value="" size="81" /></td></tr>
        </table>

        <h3>Body</h3>
        <textarea rows="10" cols="82" name="body" id="textBody"></textarea>

        <p><button type="submit">Go</button></p>
      </form>
    </div>
    <div style="display: grid; grid-template-rows: 1fr 1fr;">
      <div id="request" style="outline: solid; padding: 1em;"></div>
      <div id="result" style="outline: solid; padding: 1em;"></div>
    </div>
  </div>
</body>

<script type="text/javascript">
  async function processForm(event) {
    if (event.preventDefault) event.preventDefault();

    const requestDiv = document.getElementById("request");
    const resultDiv = document.getElementById("result");

    try {

      const corsUrl = document.querySelector('#corsUrl').value;
      console.log('corsUrl:', corsUrl);

      const methods = [...document.getElementsByName('method')];
      const method = methods.find(method => method.checked).value;
      console.log('method:', method);

      const headers = new Headers();
      headers.append("Content-Type", document.querySelector('#contentType').value); 
      headers.append("Accept-Encoding", document.querySelector('#acceptEncoding').value); 
      headers.append("Origin", document.querySelector('#origin').value);
      headers.append("Access-Control-Allow-Origin", document.querySelector('#allow').value);
      headers.append("Cookie", document.querySelector('#cookie').value);

      console.log('headers:', ...headers);

      const body = document.querySelector('#textBody').value;

      var requestOptions = {
        method,
        headers,
        redirect: 'follow'
      };

      if (method === 'POST') {
        requestOptions.body = body;
        console.log('body:', body);
      }

      console.log(`-- fetching --`);

      let requestHtml = `
        <h2>Request</h2>
        <h3>URL: ${corsUrl}</h3>
        <h3>Method: ${method}</h3>
        <h3>Request Headers</h3>
        <pre>`;

      [...headers].forEach(head => {
        requestHtml += JSON.stringify(head) + '\n';
      })

      requestHtml += '</pre>';

      requestDiv.innerHTML = requestHtml;

      if (method==="POST") {
        requestDiv.innerHTML += `
          <h3>Response Body</h3>
          <pre>${responseBody}</pre>
        `;
      }


      let response;
      
      let responseBody;
      try {
        response = await fetch(corsUrl, requestOptions);
        response.jsonBody = await response.json();
        responseBody = JSON.stringify(response.jsonBody, null, 2);
      } catch(err) {
        responseBody = "See result in console.";
        console.log(`No valid json.`);
        response = err;
      }

      let responseHtml = `
        <h2>Response</h2>
        <h3>Status: ${response?.status || "none"}</h3>
        <h3>Response Headers</h3>
        <pre>`;

      [...(response?.headers || [])].forEach(head => {
        responseHtml += JSON.stringify(head) + '\n';
      })
         
      responseHtml += `</pre>
        <h3>Response Body</h3>
        <pre>${responseBody}</pre>
      `;

      resultDiv.innerHTML = responseHtml;

      console.log('response:', response);

    } catch (err) {
      console.log(err);
      resultDiv.innerText = err;
    }
  }

  var form = document.getElementById('cors-form');
  if (form.attachEvent) {
      form.attachEvent("submit", processForm);
  } else {
      form.addEventListener("submit", processForm);
  }

</script>
</html>
